# -----------------------------------------------------------------------------
# xdaco-ultimate-base — Debian Trixie rootless base for stateless workstation
# -----------------------------------------------------------------------------
FROM docker.io/library/debian:trixie

ARG CONTAINER_USERNAME=xdaco

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV USER=${CONTAINER_USERNAME}
ENV HOME=/home/${CONTAINER_USERNAME}
ENV PATH="$HOME/.cargo/bin:$HOME/.npm-global/bin:$HOME/.local/bin:/usr/local/bin:/usr/bin:/bin"

# -----------------------------------------------------------------------------
# System packages
# -----------------------------------------------------------------------------
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
    pkg-config libssl-dev cmake libgit2-dev \
    sudo curl wget gnupg2 lsb-release ca-certificates \
    zsh git tmux openssh-server rsync \
    build-essential gcc g++ make bash nano \
    python3 python3-venv python3-pip \
    nodejs npm php-cli php-mbstring unzip \
    bash-completion tree fzf fd-find bat jq \
    ripgrep ncdu htop btop p7zip-full zip skopeo \
    fdupes duf nmap cmus asciinema pass \
    stow neovim direnv age wego eza \
    zoxide git-delta rustc  cargo \
    fontconfig passwd  \
    ; \
    rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# UV (Python package manager)
# -----------------------------------------------------------------------------
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# -----------------------------------------------------------------------------
# diff-so-fancy
# -----------------------------------------------------------------------------
RUN curl -fsSL \
    https://github.com/so-fancy/diff-so-fancy/releases/download/v1.4.4/diff-so-fancy \
    -o /usr/local/bin/diff-so-fancy \
    && chmod +x /usr/local/bin/diff-so-fancy

# -----------------------------------------------------------------------------
# Syft (SBOM generator)
# -----------------------------------------------------------------------------
RUN curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

# -----------------------------------------------------------------------------
# User + sudo
# -----------------------------------------------------------------------------
RUN set -eux; \
    /usr/sbin/useradd -m -s /usr/bin/zsh ${CONTAINER_USERNAME} && \
    echo "${CONTAINER_USERNAME} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${CONTAINER_USERNAME} && \
    chmod 0440 /etc/sudoers.d/${CONTAINER_USERNAME}

# ----------------------------------------- ------------------------------------
# SSH daemon
# -----------------------------------------------------------------------------
RUN set -eux; \
    mkdir -p /var/run/sshd; \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config; \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config

EXPOSE 22

# -----------------------------------------------------------------------------
# Switch to user
# -----------------------------------------------------------------------------
USER ${USER}
WORKDIR ${HOME}

# -----------------------------------------------------------------------------
# Rust based tools (rootless)
# -----------------------------------------------------------------------------
RUN set -eux; \
    cargo install just || true; \
    cargo install onefetch || true; \
    cargo install atuin || true

# -----------------------------------------------------------------------------
# Oh My Zsh + Agnoster + Fonts + Starship
# -----------------------------------------------------------------------------
RUN set -eux; \
    \
    # Oh My Zsh (official unattended)
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended; \
    \
    # Agnoster theme
    git clone --depth=1 https://github.com/agnoster/agnoster-zsh-theme.git /tmp/agnoster; \
    cp /tmp/agnoster/agnoster.zsh-theme "$HOME/.oh-my-zsh/custom/themes/agnoster.zsh-theme"; \
    rm -rf /tmp/agnoster; \
    sed -i 's/^ZSH_THEME=.*/ZSH_THEME="agnoster"/' "$HOME/.zshrc"; \
    \
    # Powerline fonts
    git clone --depth=1 https://github.com/powerline/fonts.git /tmp/powerline-fonts; \
    /tmp/powerline-fonts/install.sh; \
    rm -rf /tmp/powerline-fonts; \
    \
    # Nerd Fonts (Agave + Meslo)
    mkdir -p "$HOME/.local/share/fonts"; \
    curl -fsSL https://github.com/ryanoasis/nerd-fonts/releases/download/v3.4.0/Agave.zip -o /tmp/Agave.zip; \
    curl -fsSL https://github.com/ryanoasis/nerd-fonts/releases/download/v3.4.0/Meslo.zip -o /tmp/Meslo.zip; \
    unzip -qo /tmp/Agave.zip -d "$HOME/.local/share/fonts"; \
    unzip -qo /tmp/Meslo.zip -d "$HOME/.local/share/fonts"; \
    fc-cache -fv; \
    rm -f /tmp/Agave.zip /tmp/Meslo.zip; \
    \
    # Starship (installed but not enabled)
    curl -fsSL https://starship.rs/install.sh | sh -s -- -y; \
    printf '\n# Starship (optional — disabled by default)\n# eval "$(starship init zsh)"\n' >> "$HOME/.zshrc"; \
    \
    # Download and load xdaco aliases
    curl -fsSL https://raw.githubusercontent.com/xdaco/bash-resources/master/xdaco_aliases.sh -o "$HOME/xdaco_aliases.sh"; \
    chmod +x "$HOME/xdaco_aliases.sh"; \
    printf '\n# Load xdaco aliases\nif [ -f "$HOME/xdaco_aliases.sh" ]; then\n  source "$HOME/xdaco_aliases.sh"\nfi\n' >> "$HOME/.zshrc"

# -----------------------------------------------------------------------------
# Entrypoint
# -----------------------------------------------------------------------------
WORKDIR ${HOME}
CMD ["/usr/sbin/sshd", "-D"]
