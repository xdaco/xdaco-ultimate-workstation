# Base image with digest pinning
FROM debian@sha256:56ff6d36d4eb3db13a741b342ec466f121480b5edded42e4b7ee850ce7a418ee

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Install essential system packages
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
    sudo curl wget gnupg2 lsb-release \
    zsh git tmux openssh-server rsync \
    build-essential gcc g++ make \
    python3 python3-venv python3-pip \
    nodejs npm php-cli php-mbstring unzip \
    bash-completion \
    tree fzf fd-find bat jq ripgrep ncdu \
    htop btop bottom \
    p7zip-full zip skopeo\
    diff-so-fancy fdupes duf \
    nmap wego cmus asciinema \
    pass stow neovim \
    direnv age sops \
    ; \
    rm -rf /var/lib/apt/lists/*

# Install Rust tools
RUN set -eux; \
    curl https://sh.rustup.rs -sSf | sh -s -- -y; \
    source /root/.cargo/env; \
    cargo install eza onefetch cpufetch zoxide git-delta just atuin bat-extras

ENV PATH="/root/.cargo/bin:${PATH}"

# Install Composer
RUN curl -fsSL https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Install Node dev tools
RUN npm install -g opencode @anthropic-ai/claude-code

# Create user xdaco
RUN useradd -m -s /usr/bin/zsh xdaco && \
    echo "xdaco ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/xdaco && \
    chmod 0440 /etc/sudoers.d/xdaco

# Configure SSH
RUN mkdir -p /var/run/sshd && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config

EXPOSE 22

USER xdaco
WORKDIR /home/xdaco
CMD ["/usr/sbin/sshd", "-D"]
